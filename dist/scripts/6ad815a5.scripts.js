"use strict";angular.module("logrunsApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/home.html",controller:"HomeCtrl"}).when("/u/:username",{templateUrl:"views/calendar.html",controller:"CalendarCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/signup",{templateUrl:"views/signup.html",controller:"SignupCtrl"}).when("/entry",{templateUrl:"views/newentry.html",controller:"NewEntryCtrl"}).when("/entry/:id",{templateUrl:"views/entry.html",controller:"EntryCtrl"}).when("/users",{templateUrl:"views/users.html",controller:"UsersCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("logrunsApp").factory("user",["$http",function(a){var b={},c=function(){},d="http://mysterious-ravine-3794.herokuapp.com",e=function(e){var f=e.success||c,g=e.error||c;return e.user?void a({method:"POST",url:d+"/signup",data:e.user,withCredentials:!0}).success(function(a){b.user=a,f(b.user)}).error(g):void g()},f=function(e){var f=e.success||c,g=e.error||c;return e.user?void a({method:"POST",url:d+"/login",data:e.user,withCredentials:!0}).success(function(a){b.user=a,f(b.user)}).error(g):void g()},g=function(e){var f=e.success||c,g=e.error||c;a({method:"GET",url:d+"/logout",withCredentials:!0}).success(function(){b.user=void 0,f()}).error(g)},h=function(e){var f=e.success||c,g=e.error||c;return b.user?void f(b.user):void a({method:"GET",url:d+"/profile",withCredentials:!0}).success(function(a){b.user=a.user,f(b.user)}).error(g)},i=function(c){return b.users?void c.success(b.users):void a({method:"GET",url:d+"/users"}).success(function(a){b.users=a,c.success(a)})},j=function(b){a({method:"GET",url:d+"/entries",params:{username:b.username,startDate:b.startDate,endDate:b.endDate},withCredentials:!0}).success(function(a){b.success(a)})},k=function(b){a({method:"POST",url:d+"/entry",data:b.entry,withCredentials:!0}).success(function(a){b.success(a)}).error(function(a){b.error(a)})},l=function(b){a({method:"GET",url:d+"/entry",params:{id:b.id}}).success(function(a){b.success(a)})},m=function(b){a({method:"GET",url:d+"/comments",params:{entryId:b.entryId}}).success(b.success)},n=function(b){a({method:"POST",url:d+"/comment",data:b.comment,withCredentials:!0}).success(b.success)};return{signup:e,login:f,logout:g,getUser:h,getUsers:i,getEntries:j,postEntry:k,getEntry:l,getComments:m,postComment:n}}]),angular.module("logrunsApp").factory("time",function(){var a=/^[\d\:\.]*$/,b=function(b){if(!a.test(b))return 0;var c=b.split(":");return c.length>3?0:c=_.reduce(c,function(a,b,d){return a+parseFloat(b)*Math.pow(60,c.length-d-1)},0)},c=function(a){return 10>a?"0"+a:a},d=function(a){if(!a.duration||!a.distance)return"";var d=b(a.duration),e=d/parseFloat(a.distance),f="";if(a.format){d=Number(c(e%60)).toFixed(2);var g=parseInt(e/60)%60,h=parseInt(e/3600)%60;if(f=h||"",f?f+=":"+c(g):f=g||"",!f)return"";f+=":"+c(d)}return f};return{getSeconds:b,getPace:d}}),angular.module("logrunsApp").controller("HomeCtrl",["$scope","user",function(a,b){a.account="Sign in",a.date=moment(),b.getUsers({success:function(b){a.users=b}}),b.getEntries({startDate:a.date.startOf("month").toISOString(),endDate:a.date.endOf("month").toISOString(),success:function(b){a.entries=b},error:function(a){console.log(a)}}),a.getDate=function(a){return moment(a).format("MMM DD, YYYY")}}]),angular.module("logrunsApp").controller("CalendarCtrl",["$scope","$location","$routeParams","user",function(a,b,c,d){a.date=moment(),a.username=c.username,a.days=[],console.log("User: ",c.username);var e=a.getEntries=function(){d.getEntries({username:a.username,startDate:a.date.startOf("month").toISOString(),endDate:a.date.endOf("month").toISOString(),success:function(b){a.entries=b},error:function(a){console.log(a)}})};e(),a.getEntry=function(b){if(a.entries&&b){b=moment(b).zone(0);for(var c=a.entries,d=[],e=0;e<c.length;++e)b.isSame(c[e].date,"day")&&(d.push(c[e]),console.log(c[e]));return d}};var f=function(){a.daysInMonth=new Array(a.date.daysInMonth()),a.dispDate=a.date.format("MMMM")+" "+a.date.year()};f();var g=function(){var b=a.date.clone(),c=b.startOf("month").day()-1;c=7>c?c+7:c,b.subtract("days",c);for(var d=[],e=a.date.month(),f="active",g=0;42>g;g++)f=e===b.month()?"active":"inactive",d.push({day:b.date(),style:f,date:b.format("MM-DD-YYYY")}),b.add("days",1);a.days=d};g(),a.getLastMonth=function(){a.date.subtract("months",1),f()},a.getNextMonth=function(){a.date.add("months",1),f()}}]),angular.module("logrunsApp").controller("LoginCtrl",["$scope","$location","user",function(a,b,c){a.login=function(){a.user&&c.login({user:a.user,success:function(a){console.log(a),window.history.back()},error:function(){console.log("Invalid Credentials")}})}}]),angular.module("logrunsApp").controller("SignupCtrl",["$scope","$location","user",function(a,b,c){a.signup=function(){c.signup({user:a.user,success:function(a){b.path("/u/"+a.local.username)},error:function(){console.log("Username ALREADY EXISTS")}})}}]),angular.module("logrunsApp").controller("EntryCtrl",["$scope","$routeParams","$route","user","time",function(a,b,c,d,e){d.getUser({success:function(b){a.username=b.local.username},error:function(){a.username="You must sign in to comment!"}});var f=function(){d.getComments({entryId:a.entries[0]._id,success:function(b){a.comments=b}})};a.newcomment={message:""},d.getEntry({id:b.id,success:function(b){a.entries=b,f(),a.newcomment.entryId=a.entries[0]._id}}),a.formatDate=function(a){return moment(a).format("MMMM DD, YYYY")},a.postComment=function(){console.log("message",a.newcomment.message),d.postComment({comment:a.newcomment,success:function(a){console.log(a),c.reload()}})},a.getPace=function(a,b){var c=e.getPace({distance:a,duration:b,format:!0});return c}}]),angular.module("logrunsApp").controller("NewEntryCtrl",["$scope","$location","user","time",function(a,b,c,d){a.entry={},c.getUser({success:function(b){a.user=b}}),a.submit=function(){console.log(a.entry),c.postEntry({entry:a.entry,success:function(c){console.log(c),a.user&&b.path("/u/"+a.user.local.username)},error:function(a){console.error("busted",a)}})},a.getPace=function(){var b=d.getPace({distance:a.entry.distance,duration:a.entry.duration,format:!0});return b}}]),angular.module("logrunsApp").controller("UsersCtrl",["$scope","user",function(a,b){a.account="Sign in",a.date=moment(),b.getUsers({success:function(b){a.users=b}})}]),angular.module("logrunsApp").directive("toolbar",function(){return{restrict:"E",templateUrl:"../../views/templates/toolbar-template.html",controller:["$scope","user",function(a,b){b.getUser({success:function(b){a.displayName=b.local.username},error:function(){a.displayName="Sign in"}})}]}});