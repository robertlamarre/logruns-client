"use strict";angular.module("logrunsApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngQuickDate"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/home.html",controller:"HomeCtrl"}).when("/u/:username",{templateUrl:"views/calendar.html",controller:"CalendarCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/signup",{templateUrl:"views/signup.html",controller:"SignupCtrl"}).when("/newentry/:date?",{templateUrl:"views/newentry.html",controller:"NewEntryCtrl"}).when("/entry/:id",{templateUrl:"views/entry.html",controller:"EntryCtrl"}).when("/users",{templateUrl:"views/users.html",controller:"UsersCtrl"}).when("/logout",{templateUrl:"views/logout.html",controller:"LogoutCtrl"}).when("/notifications",{templateUrl:"views/notifications.html",controller:"NotificationsCtrl"}).when("/u/:username/statistics",{templateUrl:"views/statistics.html",controller:"StatisticsCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("logrunsApp").factory("user",["$http",function(a){var b={},c=function(){},d="http://mysterious-ravine-3794.herokuapp.com",e=function(e){var f=e.success||c,g=e.error||c;return e.user?void a({method:"POST",url:d+"/signup",data:e.user,withCredentials:!0}).success(function(a){b.user=a,f(b.user)}).error(g):void g()},f=function(e){var f=e.success||c,g=e.error||c;return e.user?void a({method:"POST",url:d+"/login",data:e.user,withCredentials:!0}).success(function(a){b.user=a,f(b.user)}).error(g):void g()},g=function(e){e=e||{};var f=e.success||c,g=e.error||c;a({method:"GET",url:d+"/logout",withCredentials:!0}).success(function(){b.user=void 0,f()}).error(g)},h=function(e){var f=e.success||c,g=e.error||c;return b.user?void f(b.user):void a({method:"GET",url:d+"/profile",withCredentials:!0}).success(function(a){b.user=a.user,f(b.user)}).error(g)},i=function(c){return b.users?void c.success(b.users):void a({method:"GET",url:d+"/users"}).success(function(a){b.users=a,c.success(a)})},j=function(b){a({method:"GET",url:d+"/entries",params:{username:b.username,startDate:b.startDate,endDate:b.endDate},withCredentials:!0}).success(function(a){b.success(a)})},k=function(b){a({method:"GET",url:d+"/streak",params:{username:b.username}}).success(function(a){b.success(a)})},l=function(b){a({method:"GET",url:d+"/stats",params:{username:b.username}}).success(function(a){b.success(a)})},m=function(b){a({method:"POST",url:d+"/entriesByIds",data:{ids:b.ids},withCredentials:!0}).success(function(a){b.success(a)})},n=function(b){a({method:"POST",url:d+"/entry",data:b.entry,withCredentials:!0}).success(function(a){b.success(a)}).error(function(a){b.error(a)})},o=function(b){a({method:"GET",url:d+"/entry",params:{id:b.id}}).success(function(a){b.success(a)})},p=function(b){a({method:"GET",url:d+"/comments",params:{entryId:b.entryId}}).success(b.success)},q=function(b){a({method:"POST",url:d+"/comment",data:{comment:b.comment,entryId:b.entryId},withCredentials:!0}).success(b.success)};return{signup:e,login:f,logout:g,getUser:h,getUsers:i,getEntries:j,getEntriesByIds:m,postEntry:n,getEntry:o,getComments:p,postComment:q,getStats:l,getStreak:k}}]),angular.module("logrunsApp").factory("time",function(){var a=/^[\d\:\.]*$/,b=function(b){if(!a.test(b))return 0;var c=b.split(":");return c.length>3?0:c=_.reduce(c,function(a,b,d){return a+parseFloat(b)*Math.pow(60,c.length-d-1)},0)},c=function(a){return 10>a?"0"+a:a},d=function(a){if(!a.duration||!a.distance)return"";var d=b(a.duration),e=d/parseFloat(a.distance),f="";if(a.format){d=Number(c(e%60)).toFixed(2);var g=parseInt(e/60)%60,h=parseInt(e/3600)%60;if(f=h||"",f?f+=":"+c(g):f=g||"",!f)return"";f+=":"+c(d)}return f};return{getSeconds:b,getPace:d}}),angular.module("logrunsApp").controller("HomeCtrl",["$scope","user",function(a,b){a.account="Sign in",a.date=moment(),b.getUsers({success:function(b){a.users=b}}),b.getEntries({startDate:a.date.startOf("month").toISOString(),endDate:a.date.endOf("month").toISOString(),success:function(b){a.entries=b},error:function(a){console.log(a)}}),a.getDate=function(a){return moment(a).format("MMM DD, YYYY h:mm a")}}]),angular.module("logrunsApp").controller("CalendarCtrl",["$scope","$location","$routeParams","user",function(a,b,c,d){a.date=moment(),a.username=c.username,a.days=[],a.entryMap={},console.log("User: ",c.username);var e=function(b){var c={};_.each(b,function(a){var b=moment(a.date).zone(0).format("MM-DD-YYYY");c[b]?c[b].push(a):c[b]=[a]}),a.entryMap=c,console.log(c)},f=a.getEntries=function(){var b=a.date.clone().subtract("months",1).toISOString(),c=a.date.clone().add("months",1).toISOString();d.getEntries({username:a.username,startDate:b,endDate:c,success:function(b){a.entries=e(b),i()},error:function(a){console.log(a)}})};f();var g=function(){a.daysInMonth=new Array(a.date.daysInMonth()),a.dispDate=a.date.format("MMMM")+" "+a.date.year()};g();var h=function(){var b=a.date.clone(),c=b.startOf("month").day()-1;3>=c&&(c+=7),b.subtract("days",c);var d=[],e=a.date.month(),f="active";a.firstDay=b.clone();for(var g=0;42>g;g++)f=e===b.month()?"active":"inactive",d.push({day:b.date(),style:f,date:b.format("MM-DD-YYYY")}),b.add("days",1);a.days=d},i=function(){for(var b=[0,0,0,0,0,0],c=0;6>c;++c){var d=[],e=a.firstDay.clone();e.add("days",7*c);for(var f=0;7>f;++f)if(d=a.entryMap[e.format("MM-DD-YYYY")]){for(var g=0;g<d.length;++g)b[c]+=d[g].distance;e.add("days",1)}else e.add("days",1)}a.summary=b,console.log("SUMMARY",b)},j=function(){d.getStats({username:a.username,success:function(b){console.log("STATS",b),a.stats=b}}),d.getStreak({username:a.username,success:function(b){console.log("STATS",b),a.streak=b}})};h(),j(),a.getLastMonth=function(){a.date.subtract("months",1),h(),g(),i(),j()},a.getNextMonth=function(){a.date.add("months",1),h(),g(),i(),j()}}]),angular.module("logrunsApp").controller("LoginCtrl",["$scope","$location","user",function(a,b,c){a.login=function(){a.user&&c.login({user:a.user,success:function(a){console.log(a),window.history.back()},error:function(){console.log("Invalid Credentials")}})}}]),angular.module("logrunsApp").controller("SignupCtrl",["$scope","$location","user",function(a,b,c){a.signup=function(){c.signup({user:a.user,success:function(a){b.path("/u/"+a.local.username)},error:function(){console.log("Username ALREADY EXISTS")}})}}]),angular.module("logrunsApp").controller("EntryCtrl",["$scope","$routeParams","$route","user","time",function(a,b,c,d,e){d.getUser({success:function(b){a.username=b.local.username},error:function(){a.username="You must sign in to comment!"}}),a.newcomment={message:""},d.getEntry({id:b.id,success:function(b){a.entry=b}}),a.formatDate=function(a){return moment(a).format("MMMM DD, YYYY")},a.postComment=function(){console.log("message",a.newcomment.message),a.newcomment.username=a.username,a.newcomment.date=moment(),d.postComment({comment:a.newcomment,entryId:a.entry._id,success:function(a){console.log(a),c.reload()}})},a.getPace=function(a,b){var c=e.getPace({distance:a,duration:b,format:!0});return c}}]),angular.module("logrunsApp").controller("NewEntryCtrl",["$scope","$location","$routeParams","user","time",function(a,b,c,d,e){a.value=new Date(2013,9,22),a.entry={type:"Easy",date:c.date||new Date},d.getUser({success:function(b){a.user=b}}),a.submit=function(){console.log(a.entry),d.postEntry({entry:a.entry,success:function(c){console.log(c),a.user&&b.path("/u/"+a.user.local.username)},error:function(a){console.error("busted",a)}})},a.getPace=function(){var b=e.getPace({distance:a.entry.distance,duration:a.entry.duration,format:!0});return b}}]),angular.module("logrunsApp").controller("LogoutCtrl",["user","$location",function(a,b){a.logout({success:function(){b.path("/")}})}]),angular.module("logrunsApp").controller("UsersCtrl",["$scope","user",function(a,b){a.account="Sign in",a.date=moment(),b.getUsers({success:function(b){a.users=b}})}]),angular.module("logrunsApp").controller("NotificationsCtrl",["$scope","user",function(a,b){console.log("made it");var c=function(c){var d=c.notifications.entries;0!==d.length&&b.getEntriesByIds({ids:d,success:function(b){console.log(b),a.entries=b}})};a.getDate=function(a){return moment(a).format("MMM DD, YYYY h:mm a")},b.getUser({success:function(b){a.user=b,console.log(b),c(b)}})}]),angular.module("logrunsApp").controller("StatisticsCtrl",function(){}),angular.module("logrunsApp").constant("dropdownConfig",{openClass:"open"}).service("dropdownService",["$document",function(a){var b=null;this.open=function(e){b||(a.bind("click",c),a.bind("keydown",d)),b&&b!==e&&(b.isOpen=!1),b=e},this.close=function(e){b===e&&(b=null,a.unbind("click",c),a.unbind("keydown",d))};var c=function(a){a&&a.isDefaultPrevented()||b.$apply(function(){b.isOpen=!1})},d=function(a){27===a.which&&(b.focusToggleElement(),c())}}]).controller("DropdownController",["$scope","$attrs","$parse","dropdownConfig","dropdownService","$animate",function(a,b,c,d,e,f){var g,h=this,i=a.$new(),j=d.openClass,k=angular.noop,l=b.onToggle?c(b.onToggle):angular.noop;this.init=function(d){h.$element=d,b.isOpen&&(g=c(b.isOpen),k=g.assign,a.$watch(g,function(a){i.isOpen=!!a}))},this.toggle=function(a){var b=i.isOpen=arguments.length?!!a:!i.isOpen;return b},this.isOpen=function(){return i.isOpen},i.focusToggleElement=function(){h.toggleElement&&h.toggleElement[0].focus()},i.$watch("isOpen",function(b,c){f[b?"addClass":"removeClass"](h.$element,j),b?(i.focusToggleElement(),e.open(i)):e.close(i),k(a,b),angular.isDefined(c)&&b!==c&&l(a,{open:!!b})}),a.$on("$locationChangeSuccess",function(){i.isOpen=!1}),a.$on("$destroy",function(){i.$destroy()})}]).directive("dropdown",function(){return{restrict:"CA",controller:"DropdownController",link:function(a,b,c,d){d.init(b)}}}).directive("dropdownToggle",function(){return{restrict:"CA",require:"?^dropdown",link:function(a,b,c,d){if(d){d.toggleElement=b;var e=function(e){e.preventDefault(),b.hasClass("disabled")||c.disabled||a.$apply(function(){d.toggle()})};b.bind("click",e),b.attr({"aria-haspopup":!0,"aria-expanded":!1}),a.$watch(d.isOpen,function(a){b.attr("aria-expanded",!!a)}),a.$on("$destroy",function(){b.unbind("click",e)})}}}}),angular.module("logrunsApp").directive("toolbar",function(){return{restrict:"E",templateUrl:"../../views/templates/toolbar-template.html",controller:["$scope","$document","user",function(a,b,c){a.items=[],a.loggedIn=!1;var d=function(){c.getUser({success:function(b){a.href="",a.user=b,a.loggedIn=!0,a.items=[{text:"Notifications",href:"#/notifications"},{text:"Logout",href:"#/logout"}]},error:function(){a.items=[],a.loggedIn=!1}})};a.$on("$routeChangeSuccess",d)}]}});