"use strict";angular.module("logrunsApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/home.html",controller:"HomeCtrl"}).when("/u/:username",{templateUrl:"views/calendar.html",controller:"CalendarCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/signup",{templateUrl:"views/signup.html",controller:"SignupCtrl"}).when("/entry",{templateUrl:"views/newentry.html",controller:"NewEntryCtrl"}).when("/entry/:id",{templateUrl:"views/entry.html",controller:"EntryCtrl"}).when("/users",{templateUrl:"views/users.html",controller:"UsersCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("logrunsApp").factory("user",["$http",function(a){var b={},c=function(){},d="http://mysterious-ravine-3794.herokuapp.com",e=function(e){var f=e.success||c,g=e.error||c;return e.user?void a({method:"POST",url:d+"/signup",data:e.user,withCredentials:!0}).success(function(a){b.user=a,f(b.user)}).error(g):void g()},f=function(e){var f=e.success||c,g=e.error||c;return e.user?void a({method:"POST",url:d+"/login",data:e.user,withCredentials:!0}).success(function(a){b.user=a,f(b.user)}).error(g):void g()},g=function(e){var f=e.success||c,g=e.error||c;a({method:"GET",url:d+"/logout",withCredentials:!0}).success(function(){b.user=void 0,f()}).error(g)},h=function(e){var f=e.success||c,g=e.error||c;return b.user?void f(b.user):void a({method:"GET",url:d+"/profile",withCredentials:!0}).success(function(a){b.user=a.user,f(b.user)}).error(g)},i=function(c){return b.users?void c.success(b.users):void a({method:"GET",url:d+"/users"}).success(function(a){b.users=a,c.success(a)})},j=function(b){a({method:"GET",url:d+"/entries",params:{username:b.username,startDate:b.startDate,endDate:b.endDate},withCredentials:!0}).success(function(a){b.success(a)})},k=function(b){a({method:"POST",url:d+"/entry",data:b.entry,withCredentials:!0}).success(function(a){b.success(a)}).error(function(a){b.error(a)})},l=function(b){a({method:"GET",url:d+"/entry",params:{id:b.id}}).success(function(a){b.success(a)})},m=function(b){a({method:"GET",url:d+"/comments",params:{entryId:b.entryId}}).success(b.success)},n=function(b){a({method:"POST",url:d+"/comment",data:b.comment,withCredentials:!0}).success(b.success)};return{signup:e,login:f,logout:g,getUser:h,getUsers:i,getEntries:j,postEntry:k,getEntry:l,getComments:m,postComment:n}}]),angular.module("logrunsApp").controller("HomeCtrl",["$scope","user",function(a,b){a.account="Sign in",a.date=moment(),b.getUsers({success:function(b){a.users=b}}),b.getEntries({startDate:a.date.startOf("month").toISOString(),endDate:a.date.endOf("month").toISOString(),success:function(b){a.entries=b},error:function(a){console.log(a)}})}]),angular.module("logrunsApp").controller("CalendarCtrl",["$scope","$location","$routeParams","user",function(a,b,c,d){a.date=moment(),a.username=c.username,console.log("User: ",c.username);var e=a.getEntries=function(){d.getEntries({username:a.username,startDate:a.date.startOf("month").toISOString(),endDate:a.date.endOf("month").toISOString(),success:function(b){a.entries=b},error:function(a){console.log(a)}})};e(),a.getEntry=function(b){if(a.entries&&b){for(var c=a.entries,d=[],e=a.date.endOf("day").add("hours",4).date(b).zone(0),f=0;f<c.length;++f)e.isSame(c[f].date,"day")&&(d.push(c[f]),console.log(c[f]));return d}};var f=function(){a.daysInMonth=new Array(a.date.daysInMonth()),a.dispDate=a.date.format("MMMM")+" "+a.date.year()};f(),a.getDays=function(){var b=a.date.startOf("month").day()-1;b=0>b?6:b;for(var c=new Array(b),d=0;d<a.date.daysInMonth();++d)c.push(d+1);return c},a.getLastMonth=function(){a.date.subtract("months",1),f()},a.getNextMonth=function(){a.date.add("months",1),f()}}]),angular.module("logrunsApp").controller("LoginCtrl",["$scope","$location","user",function(a,b,c){a.login=function(){a.user&&c.login({user:a.user,success:function(a){console.log(a),b.path("/u/"+a.local.username)},error:function(){console.log("Invalid Credentials")}})}}]),angular.module("logrunsApp").controller("SignupCtrl",["$scope","$location","user",function(a,b,c){a.signup=function(){c.signup({user:a.user,success:function(a){b.path("/u/"+a.local.username)},error:function(){console.log("Username ALREADY EXISTS")}})}}]),angular.module("logrunsApp").controller("EntryCtrl",["$scope","$routeParams","$route","user",function(a,b,c,d){d.getUser({success:function(b){a.username=b.local.username},error:function(){a.username="You must sign in to comment!"}});var e=function(){d.getComments({entryId:a.entries[0]._id,success:function(b){a.comments=b}})};a.newcomment={message:""},d.getEntry({id:b.id,success:function(b){a.entries=b,e(),a.newcomment.entryId=a.entries[0]._id}}),a.formatDate=function(a){return moment(a).format("MMMM DD, YYYY")},a.postComment=function(){console.log("message",a.newcomment.message),d.postComment({comment:a.newcomment,success:function(a){console.log(a),c.reload()}})}}]),angular.module("logrunsApp").controller("NewEntryCtrl",["$scope","$location","user",function(a,b,c){a.entry={},c.getUser({success:function(b){a.user=b}}),a.submit=function(){console.log(a.entry),c.postEntry({entry:a.entry,success:function(c){console.log(c),a.user&&b.path("/u/"+a.user.local.username)},error:function(a){console.error("busted",a)}})}}]),angular.module("logrunsApp").controller("UsersCtrl",["$scope","user",function(a,b){a.account="Sign in",a.date=moment(),b.getUsers({success:function(b){a.users=b}})}]),angular.module("logrunsApp").directive("toolbar",function(){return{restrict:"E",templateUrl:"../../views/templates/toolbar-template.html",controller:["$scope","user",function(a,b){b.getUser({success:function(b){a.displayName=b.local.username},error:function(){a.displayName="Sign in"}})}]}});